<!DOCTYPE html><html> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.1.1"><title>使用 Wireshark 进行嗅探实验</title><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Noto+Serif+SC:wght@200;300;400;500;600;700;900&display=swap"><!-- Matomo --><script>
      var _paq = (window._paq = window._paq || []);
      _paq.push(["trackPageView"]);
      _paq.push(["enableLinkTracking"]);
      (function () {
        var u = "//analytics.skywt.cn/";
        _paq.push(["setTrackerUrl", u + "matomo.php"]);
        _paq.push(["setSiteId", "1"]);
        var d = document,
          g = d.createElement("script"),
          s = d.getElementsByTagName("script")[0];
        g.async = true;
        g.src = u + "matomo.js";
        s.parentNode.insertBefore(g, s);
      })();
    </script><!-- End Matomo Code --><link rel="stylesheet" href="/_astro/about.4DFoe-cT.css" />
<style>img[data-astro-cid-4sn4zg3r]{border-radius:.25rem;--tw-shadow: 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);--tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}
</style>
<link rel="stylesheet" href="/_astro/friends.CELmKF_Q.css" /></head> <body> <header class="mt-12 wide-container" data-astro-cid-3ef6ksr2> <h5 class="mt-4 mx-4 secondary-color sm:hidden text-center" data-astro-cid-3ef6ksr2> <a href="/" class="link">SkyWT</a> <span>
/
<a href="/blog" class="link"> 博客</a> </span><span>
/
使用 Wireshark 进行嗅探实验 </span> </h5> </header> <nav class="py-2 font-thin sticky top-0 backdrop-blur-md z-10 transition-all" id="navbar-wrapper" data-astro-cid-3ef6ksr2> <div class="wide-container flex justify-center sm:justify-between flex-wrap" data-astro-cid-3ef6ksr2> <h5 class="m-2 hidden sm:block secondary-color" data-astro-cid-3ef6ksr2> <a href="/" class="link">SkyWT</a> <span>
/
<a href="/blog" class="link"> 博客</a> </span><span>
/
使用 Wireshark 进行嗅探实验 </span> </h5> <div class="m-2 secondary-color" data-astro-cid-3ef6ksr2> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> <i class="ri-home-line" data-astro-cid-tfcnbjmv></i>
主页
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv> <i class="ri-newspaper-line" data-astro-cid-tfcnbjmv></i> 博客 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv> <i class="ri-server-line" data-astro-cid-tfcnbjmv></i> 实验室 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/friends" data-astro-cid-tfcnbjmv> <i class="ri-contacts-line" data-astro-cid-tfcnbjmv></i> 友人 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv> <i class="ri-cup-line" data-astro-cid-tfcnbjmv></i> 关于 </a> </li> </ul>  </div> </div> </nav> <script>
  const headerEl = document.querySelector("#navbar-wrapper");
  const sentinalEl = document.querySelector("header");
  const handler = (entries) => {
    if (!entries[0].isIntersecting) {
      headerEl.classList.add("sticked");
    } else {
      headerEl.classList.remove("sticked");
    }
  };
  const observer = new window.IntersectionObserver(handler);
  observer.observe(sentinalEl);
</script>   <main data-astro-cid-4sn4zg3r> <section class="container mt-32" data-astro-cid-4sn4zg3r>  <h1 class="primary-color leading-relaxed" data-astro-cid-4sn4zg3r>使用 Wireshark 进行嗅探实验</h1> <p class="mt-4 secondary-color leading-relaxed" data-astro-cid-4sn4zg3r> <i class="ri-calendar-line" data-astro-cid-4sn4zg3r></i> <span data-astro-cid-4sn4zg3r>2023 年 03 月 26 日</span>   <br data-astro-cid-4sn4zg3r> <i class="ri-discuss-line" data-astro-cid-4sn4zg3r></i> <span data-astro-cid-4sn4zg3r>共 2 条评论</span>  </p> <hr class="my-8" data-astro-cid-4sn4zg3r> <p class="card p-2 my-8" data-astro-cid-4sn4zg3r>
⚙️ 全新博客前端仍在测试中。如果文章显示不正常，可以尝试访问<a href="https://blog.skywt.cn/posts/wireshark-sniff" class="link underline" data-astro-cid-4sn4zg3r>原博客的这篇文章</a>。
</p> <article class="prose dark:prose-neutral dark:prose-invert max-w-none" data-astro-cid-4sn4zg3r> <p>（这是 HNU 肖晟老师的《计算机网络》第一次实验）</p><!--more--><h2>实验环境</h2><p>手机（iPhone）开启热点作为 gateway，让电脑（MacBook）连接热点作为<strong>攻击者</strong>，平板（iPad）也连接热点作为 <strong>victim</strong>。让我们来看看，当 victim 上网时，攻击者能看到什么。</p><h2>混杂模式</h2><p>大多数的网卡都支持开启混杂模式（promiscuous mode），只是一般工作在非混杂模式下。<br>在混杂模式下，网卡可以接收所有经过它的数据流，不论目的地是否是它。</p><p>在一般 Linux 发行版中需要手动开启混杂模式：</p><pre><code class="lang-shell">ip link set eth0 promisc on</code></pre><p>开启之后，网卡应该就可以支持混杂模式了。</p><p>在终端使用 <code>ifconfig</code> 查看网卡接口信息，接口的 flags 中包含 PROMISC 就说明目前支持混杂模式，例如：</p><pre><code>...
en0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
    options=6463&lt;RXCSUM,TXCSUM,TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM&gt;
    ether 1c:91:80:e2:0f:f6 
    inet6 fe80::1878:5529:853f:6fa1%en0 prefixlen 64 secured scopeid 0xc 
    inet 192.168.86.20 netmask 0xffffff00 broadcast 192.168.86.255
    inet6 240e:468:490:e659:402:bca2:58e4:dbae prefixlen 64 autoconf secured 
    inet6 240e:468:490:e659:e445:33c7:a581:43c8 prefixlen 64 autoconf temporary 
    nd6 options=201&lt;PERFORMNUD,DAD&gt;
    media: autoselect
    status: active
...</code></pre><p>MacBook 的 macOS 中网络接口命名和一般的设备不同，使用 <code>ifconfig</code> 显示时，<code>en0</code> 才是 Wi-Fi 网卡接口。可以在「系统信息.app」查看，或者直接看当前 active 的接口。</p><h2>安装配置 Wireshark</h2><p>macOS 下使用 homebrew 安装 Wireshark 时，formula 的版本和 cask 的版本存在 conflict，不能共存。只要安装 cask 的版本（带图形界面的）即可。（从官网下载安装是一样的）</p><pre><code class="lang-shell">brew install --cask wireshark</code></pre><p>开启后会提示安装 ChmodBPF，否则无法使用。安装之后打开会发现还是提示没有安装，这时候还要给权限才能用：</p><pre><code class="lang-shell">sudo chmod 666 /dev/bpf*</code></pre><p>给权限之后打开 Wireshark 就可以抓包了。注意 macOS 重启之后这个权限会重置，需要重新设置。</p><h2>ARP 欺骗</h2><p>开启了混杂模式只是保障了我们可以嗅探，但是这时候局域网内的其他主机并不愿意把包发给我们。我们要进行 ARP 欺骗，将自己伪装成一个 gateway，让其他主机乖乖地把包发给我们。</p><p>我们使用 ettercap 工具进行 ARP 欺骗。Windows 平台建议使用 <a href="https://github.com/alandau/arpspoof">arpspoof</a>，这个程序更加简单轻量。</p><pre><code class="lang-shell">brew install ettercap
sudo ettercap -G # 以图形界面方式运行 Ettercap，注意要 sudo！</code></pre><p>启动 Ettercap 后，进行 host 扫描或者等待自动探测 host，然后将 host list 中目标主机（即想要欺骗的 victim）加入 target1，将 gateway 加入 target2。<br>注意同一主机在 list 里可能有 IPv4 和 IPv6 两个表项，看 mac 地址可以区分（同一主机 mac 地址相同）。</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/283364306.png" alt="Ettercap 中的 host list" title="Ettercap 中的 host list"></p><p>如何才能确定这些 IP 谁是谁的呢？<br>对于 victim 的 IP，可以直接在 victim 设备的设置里查看，网络设置中会显示自己被分配到的 IP。有些时候，这个 list 里的 description 会显示设备名称。<br>对于 gateway 的 IP，则可以在任何连接该局域网的设备设置里看到，显示的「网关 IP」即是。<br>这个 list 中的 <code>192.168.86.236</code> 就是我们的 victim。</p><p>配置好 target 后，点击 MITM menu 里的 ARP poisoning 就可以启动 ARP 欺骗。这时候在 Wireshark 里就能抓到局域网内其他主机的包了。</p><h2>使用 Wireshark 抓包</h2><p>在 Wireshark 里筛选相应 IP 的包，就可以看到与 victim 有关的包。可以这么写查询语句：<code>ip.addr == 192.168.86.236</code>。</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/1474478491.png" alt="嗅探到的有关 victim 的所有包" title="嗅探到的有关 victim 的所有包"></p><p>可以看到各种协议的流量，TCP、ARP、MDNS、HTTP……</p><p>观察截图中的 48 号开始的数据包，可以发现这完整演示了 TCP 三次握手的过程：</p><ul><li>48 号 victim 向服务器 <code>61.187.64.7</code> 发送 SYN=1 的包，结果 49 号重传了（可能因为网络问题没有发送成功），这就是第一次握手；</li><li>51 号，服务器向 victim 发回了 SYNACK 的包，这就是第二次握手，结果这个包又重传了；</li><li>53 号则是 victim 最后向服务器发送了 SYN=0 的 ACK 包，这就是第三次握手，TCP 连接建立成功！</li></ul><p>这个 TCP 连接用于什么目的呢？可以看到接下来对于这个服务器的一个请求就是 HTTP GET，也就是 victim 访问了湖大统一身份认证页面的网页。至此，我们直观地看到了从建立 TCP 连接到发送 HTTP 请求的全过程。</p><p>还注意到，这个连接由 victim 的 60431 端口和服务器的 80 端口建立。在下面的其他数据包里，victim 的端口各不相同，端口号都大于 60000。看来，发送端的确是任意选择一个不定端口进行发送的。</p><h2>实践：湖大统一身份认证登陆</h2><p>现在还有什么现代网站使用 HTTP 吗？答案是肯定的，比如：湖南大学「统一身份认证」的<a href="http://cas.hnu.edu.cn/cas/login">登录页面</a>。这个页面是完全不支持 HTTPS。<br>那么理论上来说，我是不是可以看到在相同局域网登陆的同学的密码呢？</p><p><img src="https://blog.skywt.cn/usr/uploads/2022/05/1036085568.png" alt="就 TM 你没用 HTTPS 是吧？" title="就 TM 你没用 HTTPS 是吧？"></p><p>将前面的一切都配置好之后，在同一个局域网下，在目标设备上登录，筛选 Wireshark 的条件为发自 victim 的 IP 和使用 HTTP 协议，可以写 <code>ip.src == 192.168.86.236 &amp;&amp; http</code>。</p><p>确实看到了目标设备浏览器发出的 HTTP 请求！<br>查看包内容，可以看到表单发送的四个字段，其中赫然包含着这个 password：</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/253211991.png" alt="捕获 victim 登录湖大统一认证的请求" title="捕获 victim 登录湖大统一认证的请求"></p><p>然而查看发现，这个内容是加密的。结合之前<a href="https://blog.skywt.cn/posts/hnu-portal-login-analysis-implementation">对湖大登录认证的研究</a>，在发送表单之前会对 password 进行 RSA 加密，加密的公钥是加载网页之初向服务器请求的（每次都不同），而对应的密钥只有服务器后端知道。所以，我们只能截获加密后的内容，没有服务器端的密钥就是没法解密的。<br>看来，虽然没有使用 HTTP，但是湖大统一认证的密码登录还是相对安全的。</p><p>值得注意的是，统一身份认证的登录页面使用了这种比较精巧的设计，利用非对称加密、每次生成不同的密钥对等来确保我们抓到的包看不到密码（也可能是因为有这样一套 HTTP 下也相对安全的机制，信息化办才不愿意升级 HTTPS），然而大多数的登录表单并不会采用这样复杂的设计，绝大多数还是直接明文发送密码或者密码哈希。如果不使用 HTTPS，确实会有很大的安全性问题。</p><h2>校园网的 AP 隔离</h2><p>马上我们就可以看到「在湖大登录个人门户」是「安全的」的另一个原因：校园网的 AP 隔离。如果两个设备都连在校园网，它们彼此之间是无法访问的，并不像一般的局域网一样。正因如此，校园网内不能联机玩 Minecraft。</p><p>所以，连接湖大校园网 Wi-Fi 时是无法进行这个实验的，即使进行了 ARP 欺骗，Wireshark 也无法嗅探到局域网其他主机发送的包，只能看到一些无意义的 MDNS 查询：</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/1925014871.png" alt="校园网中只能嗅探到一些无意义的 MDNS 查询" title="校园网中只能嗅探到一些无意义的 MDNS 查询"></p><p>所以校园网内嗅探是不可行的。</p><h2>HTTPS 下能嗅探吗？</h2><p>如果主机使用 HTTPS 访问网站，我们还能看到其发送的请求吗？</p><p>仍然使用之前嗅探的实验环境，在 victim 上访问 HTTPS 网站进行登录操作，比如学习通：</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/1425411779.jpeg" alt="学习通的登录页面" title="学习通的登录页面"></p><p>可以看到这个页面是使用 HTTPS 连接的。在这个页面输入账号密码登录，用 Wireshark 能够嗅探到：</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/337506762.png" alt="和学习通服务器建立 HTTPS 连接的过程" title="和学习通服务器建立 HTTPS 连接的过程"></p><p>我们知道 HTTPS 建立在服务器的 443 端口。可以看到，我们抓取到了 victim 和超星学习通服务器建立连接的 TCP 包（也就是发向 443 端口的这一系列包），但是在这之后发的包并没有使用 HTTP 协议（或者 HTTPS 协议？），而是使用了 TLSv1.2 协议。TLS 的全称是 Transport Layer Security，顾名思义是个加密协议。事实上对于这些使用 TLS 加密发送的数据包，我们查看只能看到一堆乱码。</p><p>比较诡异的是，学习通登录之后自动重定向到了一个 HTTP 页面，所以上图最后几行开始又是 HTTP 协议……不知道这垃圾平台的开发者是怎么想的。<br>如果筛选所有 HTTP 包，就只能看到登录成功、重定向之后 GET 的那些内容，看不到表单登陆 POST 账号密码的内容。</p><p><img src="https://blog.skywt.cn/usr/uploads/2023/03/2531142958.png" alt="筛选 HTTP 包，只能看到 HTTP GET" title="筛选 HTTP 包，只能看到 HTTP GET"></p><p>综上所述，HTTPS 实际是「HTTP over TLS/SSL」，也就是用 TLS 这类加密协议传输的 HTTP，所以在 Wireshark 里捕获不到 HTTP 的请求内容，只能看到一个个加密后的 TLS 包。</p> </article> <hr class="my-8" data-astro-cid-4sn4zg3r> <h2> <i class="ri-discuss-line"></i> 共 2 条评论 </h2> <div class="primary-color my-4"> <div class="flex items-center"> <img src="https://gravatar.com/avatar/3558c3359c9b5ec8866e034d37997dbf" class="rounded-full w-12 mr-2"> <div class="m-2"> <a href="https://meledee.com/" class="link" target="_blank"> <h4>美樂地</h4> </a> <p class="mt-1">2023 年 3 月 26 日 11:37</p> </div> </div> <p class="mt-2">嗅探能看到正访问的HTTPS网址吗？</p> <div class="ml-8"> <div class="primary-color my-4"> <div class="flex items-center"> <img src="https://gravatar.com/avatar/5e41558bb32a2583cb14e6940b9b62ed" class="rounded-full w-12 mr-2"> <div class="m-2"> <a href="https://skywt.cn/" class="link" target="_blank"> <h4>SkyWT</h4> </a> <p class="mt-1">2023 年 3 月 26 日 12:6</p> </div> </div> <p class="mt-2">DNS 查询好像是能看到的（除非本地缓存）</p> <div class="ml-8">  </div> </div> </div> </div> <hr class="my-8"> <h2> <i class="ri-discuss-line"></i>
发表评论
</h2> <p class="primary-color card my-4 p-2">
🚧 新博客系统的评论功能仍在开发中，敬请期待。可以前往<a href="https://blog.skywt.cn/posts/wireshark-sniff" class="link underline">原博客的这篇文章</a>底部评论区发表评论。
</p> </section> </main>  <footer class="mt-16 py-8 bg-gray-100 dark:bg-neutral-900"> <div class="wide-container secondary-color text-sm"> <div class="m-2 flex justify-between flex-wrap"> <div class="m-2"> <a href="/" class="link">SkyWT</a> <span>
/
<a href="/blog" class="link"> 博客</a> </span><span>
/
使用 Wireshark 进行嗅探实验 </span> </div> <div class="m-2"> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> 
主页
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv>  博客 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv>  实验室 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/friends" data-astro-cid-tfcnbjmv>  友人 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv>  关于 </a> </li> </ul>  </div> </div> <hr> <div class="m-2 flex justify-between flex-wrap"> <p class="m-2">
&#169; 2017-2024 <a href="https://skywt.cn/" class="link">SkyWT</a> /
<a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33080202000472" target="_blank" class="link before:content-[url('/mps.png')] before:align-middle">
浙公网安备33080202000472号</a> /
<a href="https://beian.miit.gov.cn/" target="_blank" class="link">
浙ICP备2021019606号-1
</a> </p> <div class="m-2"> <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" class="inline-block mx-1" data-astro-cid-h3ykra2n> <img class="icon" src="/cc/cc.svg" data-astro-cid-h3ykra2n> <img class="icon" src="/cc/by.svg" data-astro-cid-h3ykra2n> <img class="icon" src="/cc/nc.svg" data-astro-cid-h3ykra2n>   </a>  <a href="https://notbyai.fyi" target="_blank" class="inline-block mx-1" data-astro-cid-hwbnc4sm> <img src="/not-by-ai-light.svg" alt="Not By AI Badge" class="badge inline-block dark:hidden" data-astro-cid-hwbnc4sm> <img src="/not-by-ai-dark.svg" alt="Not By AI Badge" class="badge hidden dark:inline-block" data-astro-cid-hwbnc4sm> </a>  <a href="https://www.foreverblog.cn/" target="_blank" class="inline-block mx-1"> <img src="https://img.foreverblog.cn/logo_en_default.png" alt="Forever Blog Badage" class="inline-block h-4 grayscale"> </a> </div> </div> </div> </footer> </body></html> 